"use strict";const URL=require("url"),fs=require("fs"),path=require("path"),utilsTool=require("./utils"),proxyTool=require("./proxy"),mockTool=require("./mock"),encoding=utilsTool.encoding;module.exports=(cfgs=>{let dyncConfigPath;return"string"==typeof cfgs&&(dyncConfigPath=cfgs),(req,res,next)=>{dyncConfigPath&&(delete require.cache[dyncConfigPath],cfgs=require(dyncConfigPath));const urlInfo=URL.parse(req.url,!0),cfg=utilsTool.getApiConfig(urlInfo.pathname,cfgs);if(cfg){const isFormData=(req.headers["content-type"]||"text/plain;charset="+encoding).indexOf("application/x-www-form-urlencoded")>-1,method=req.method.toUpperCase(),headers={};for(let key in req.headers)headers[key]=req.headers[key];let proxyConfig=proxyTool.getProxy(req,cfg.proxyConfig);utilsTool.getParams(req,urlInfo.query,method,isFormData,proxyConfig).then(params=>{proxyConfig?proxyTool.doProxy(req,res,headers,params,method,proxyConfig):mockTool.doMock(urlInfo.pathname,req,res,params,cfg)})}else{if("/show-apis"!==urlInfo.pathname)return next();res.end(require("./render")(utilsTool.getApiDocData(cfgs)))}}});