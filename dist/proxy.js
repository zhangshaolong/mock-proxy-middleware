const queryString=require("querystring"),utilsTool=require("./utils"),http=require("http"),https=require("https"),encoding=utilsTool.encoding,proxyReg=/^([^:]+):(\d+)$/,showProxyLog=(options,method,redirectUrl,data)=>{data.length>2e3?console.log(`proxy request: \n\tHost:${options.host}\n\tPort:${options.port}\n\tMethod:${method}\n\tPath:${redirectUrl}\n\tParams:too large not display`):console.log(`proxy request: \n\tHost:${options.host}\n\tPort:${options.port}\n\tMethod:${method}\n\tPath:${redirectUrl}\n\tParams:${data}`)},proxyResponse=(proxyRes,res)=>{let headers=proxyRes.headers,statusCode=proxyRes.statusCode;try{if(headers)for(let key in headers)res.setHeader(key,headers[key]);res.writeHead(statusCode)}catch(e){console.log("setHeader error",e.message)}utilsTool.mergeData(proxyRes).then(data=>{res.end(data,encoding)})},getProxy=(request,proxyConfig)=>{if(proxyConfig){if(proxyConfig.host&&(!proxyConfig.ignorePaths||!proxyConfig.ignorePaths[request.path]))return proxyConfig;if(proxyConfig.ignorePaths&&proxyReg.test(proxyConfig.ignorePaths[request.path]))return{...proxyConfig,host:RegExp.$1,port:RegExp.$2||""}}return!1},doProxy=(request,response,headers,params,method,proxyConfig)=>{const isHttps="https"===request.protocol;let redirectUrl=request.url;proxyConfig.redirect&&(redirectUrl=proxyConfig.redirect(redirectUrl)),headers.host=proxyConfig.host+proxyConfig.port?":"+proxyConfig.port:"";const options={host:proxyConfig.host,port:proxyConfig.port,path:redirectUrl,method:request.method,headers:headers,timeout:3e4,rejectUnauthorized:!1};showProxyLog(proxyConfig,method,redirectUrl,params),(postData=>{let proxyReq=(isHttps?https:http).request(options,proxyRes=>{proxyResponse(proxyRes,response)});proxyReq.on("error",e=>{response.end(JSON.stringify({status:500,e:e.message})),console.log("proxyReq error: "+e.message)}),proxyReq.end(postData,encoding)})(params)};module.exports={doProxy:doProxy,getProxy:getProxy};